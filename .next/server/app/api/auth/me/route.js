"use strict";(()=>{var e={};e.id=8788,e.ids=[8788],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},40812:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>w,patchFetch:()=>m,requestAsyncStorage:()=>c,routeModule:()=>p,serverHooks:()=>f,staticGenerationAsyncStorage:()=>h});var n={};r.r(n),r.d(n,{GET:()=>l});var a=r(49303),s=r(88716),u=r(60670),i=r(87070),o=r(90455),d=r(83493);async function l(e){try{let t=(e.headers.get("cookie")||"").match(/denuel_token=([^;]+)/);if(!t)return i.NextResponse.json({user:null});let r=t[1],n=(0,o.$v)(r);if(!n)return i.NextResponse.json({user:null});let a=await d.Z.user.findUnique({where:{id:n.id}});if(!a)return i.NextResponse.json({user:null});return delete a.password,i.NextResponse.json({user:a})}catch(e){return i.NextResponse.json({user:null})}}let p=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/auth/me/route",pathname:"/api/auth/me",filename:"route",bundlePath:"app/api/auth/me/route"},resolvedPagePath:"C:\\Users\\DENUEL\\Documents\\denuel app rental\\app\\api\\auth\\me\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:c,staticGenerationAsyncStorage:h,serverHooks:f}=p,w="/api/auth/me/route";function m(){return(0,u.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:h})}},90455:(e,t,r)=>{r.d(t,{$v:()=>m,Gv:()=>w,LY:()=>v,PR:()=>x,cL:()=>S,c_:()=>f,mk:()=>g,requireCsrf:()=>k,si:()=>R});var n=r(41482),a=r.n(n),s=r(42023),u=r.n(s),i=r(83493),o=r(84770),d=r.n(o);let l=process.env.JWT_SECRET||"changeme",p=process.env.REFRESH_TOKEN_SECRET||process.env.JWT_SECRET||"changeme",c="denuel_csrf";function h(e){return d().createHash("sha256").update(e).digest("hex")}function f(e){let t=u().genSaltSync(10);return u().hashSync(e,t)}function w(e,t){return u().compareSync(e,t)}function m(e){try{return a().verify(e,l)}catch(e){return null}}async function x(e){try{let t=(e.headers.get("cookie")||"").match(/denuel_token=([^;]+)/);if(!t)return null;let r=t[1],n=m(r);if(!n)return null;let a=await i.Z.user.findUnique({where:{id:n.id}});if(!a)return null;return delete a.password,a}catch(e){return null}}async function g(e,t=[]){let r=(e.headers.get("cookie")||"").match(/denuel_token=([^;]+)/);if(!r)throw new Response("Unauthorized",{status:401});let n=m(r[1]);if(!n)throw new Response("Unauthorized",{status:401});let a=await i.Z.user.findUnique({where:{id:n.id}});if(!a)throw new Response("Unauthorized",{status:401});if(t.length&&!t.includes(a.role))throw new Response("Forbidden",{status:403});return delete a.password,a}async function S(e,t){let r=function(e,t="7d"){return a().sign(e,l,{expiresIn:t})}({id:t.id,role:t.role},"7d"),n=d().randomUUID(),s=a().sign({id:t.id,jti:n},p,{expiresIn:"30d"}),u=h(s),o=new Date(Date.now()+2592e6);await i.Z.refreshToken.create({data:{userId:t.id,tokenHash:u,jti:n,expiresAt:o}}),e.headers.append("Set-Cookie",`denuel_token=${r}; HttpOnly; Path=/; Max-Age=604800; SameSite=Lax; Secure=true`),e.headers.append("Set-Cookie",`denuel_refresh=${s}; HttpOnly; Path=/; Max-Age=2592000; SameSite=Lax; Secure=true`);let f=d().randomBytes(24).toString("hex");return e.headers.append("Set-Cookie",`${c}=${f}; Path=/; Max-Age=86400; SameSite=Lax; Secure=true`),e}async function R(e){if(!e)return null;try{let t=a().verify(e,p),r=t.jti,n=await i.Z.refreshToken.findUnique({where:{jti:r}});if(!n||n.isRevoked||n.expiresAt<new Date||h(e)!==n.tokenHash)return null;let s=await i.Z.user.findUnique({where:{id:t.id}});if(!s)return null;return delete s.password,{user:s,jti:r}}catch(e){return null}}function k(e){let t=(e.headers.get("x-csrf-token")||"").toString(),r=(e.headers.get("cookie")||"").match(RegExp(`${c}=([^;]+)`));if(!r)throw new Response("Invalid CSRF token",{status:403});let n=r[1];if(!t||t!==n)throw new Response("Invalid CSRF token",{status:403});return!0}async function v(e){await i.Z.refreshToken.updateMany({where:{jti:e},data:{isRevoked:!0}})}},83493:(e,t,r)=>{r.d(t,{Z:()=>s,_:()=>a});let n=require("@prisma/client"),a=global.prisma||new n.PrismaClient,s=a}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[8948,3652,1482,5972,2023],()=>r(40812));module.exports=n})();